name: Deploy to EC2

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"
                  cache-dependency-path: "**/package-lock.json"

            - name: Install Dependencies
              run: |
                  cd client && npm ci
                  cd ../server && npm ci

            - name: Build Client
              run: |
                  cd client && npm run build

            - name: Deploy to EC2
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_KEY }}
                  script: |
                      # Pull latest changes
                      cd /path/to/app
                      git pull origin main

                      # Install dependencies and build
                      cd client
                      npm ci
                      npm run build

                      cd ../server
                      npm ci

                      # Restart application (example with PM2)
                      pm2 restart ecosystem.config.js || pm2 restart all
